<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo del Torneo</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <header>
        <a href="https://blogsaverroes.juntadeandalucia.es/iestorrredelosguzmanes/" target="_blank">
            <img src="img/logo.png" alt="Logotipo Instituto" id="logo">
        </a>
        <h1>Sorteo del Torneo de Debate</h1>
        <div class="contenedorBotonInicio">
            <button onclick="goHome()">Inicio</button>
        </div>
    </header>

    <div id="contenedorSeleccion" class="contenedor-seleccion">
        <label for="fase">Selecciona una fase:</label>
        <select id="fase" class="faseSelector" onchange="cargarPruebas()">
            <option value="">-- Selecciona --</option>
            <option value="Primera Fase">Primera Fase</option>
            <option value="Segunda Fase">Segunda Fase</option>
            <option value="Semifinal">Semifinal</option>
            <option value="Final">Final</option>
        </select>
        
        <label for="prueba">Selecciona una prueba:</label>
        <select id="prueba" class="pruebaSelector">
            <option value="">-- Primero elige una fase --</option>
        </select>

        <h2>Equipos Participantes</h2>
        <input type="text" id="equipoInput" placeholder="Nombre del equipo">
        <button onclick="agregarEquipo()">Agregar Equipo</button>
        <ul id="listaEquipos"></ul>

        <button class="botones" onclick="realizarSorteo()">Hacer sorteo</button>

        <div id="contenedorCruces" class="contenedor-cruces">
            <div id="listadoCruces" class="listadoCruces"></div>
        </div>
    </div>

    <script>
        let equipos = [];
        let sorteoCruces = []; 

        function goHome() {
            window.location.href = 'http://localhost:8080/ejemplo/';
        }

        function cargarPruebas() {
            let fase = document.getElementById("fase").value;
            let pruebaSelector = document.getElementById("prueba");
            
            pruebaSelector.innerHTML = "<option value=''>-- Selecciona una prueba --</option>";

            const pruebasPorFase = {
                "Primera Fase": ["Mejor Introducción", "Debate inicial", "Mejor Refutación"],
                "Segunda Fase": ["Mejor Argumentación", "Contra-Argumentación"],
                "Semifinal": ["Mejor Estrategia"],
                "Final": ["Defensa Final"]
            };

            if (pruebasPorFase[fase]) {
                for (let prueba of pruebasPorFase[fase]) {
                    let option = new Option(prueba, prueba);
                    pruebaSelector.appendChild(option);
                }
            }
        }
        
    

        function agregarEquipo() {
            let equipoInput = document.getElementById("equipoInput");
            let equipoNombre = equipoInput.value.trim();

            if (equipoNombre === "") {
                Swal.fire("❌ Introduce un nombre válido.");
                return;
            }

            equipos.push(equipoNombre);
            equipoInput.value = "";

            actualizarListaEquipos();
        }

        function actualizarListaEquipos() {
            let listaEquipos = document.getElementById("listaEquipos");
            listaEquipos.innerHTML = "";

            equipos.forEach(equipo => {
                let item = document.createElement("li");
                item.textContent = equipo;
                listaEquipos.appendChild(item);
            });
        }

        function realizarSorteo() {
            let fase = document.getElementById("fase").value;
            let prueba = document.getElementById("prueba").value;

            if (!fase || !prueba || equipos.length < 2) {
                Swal.fire("Debes seleccionar una fase y una prueba, y agregar al menos dos equipos.");
                return;
            }

            let url = `http://localhost:8080/ejemplo/ProyectoServlet?action=generarCruces&fase=${encodeURIComponent(fase)}&prueba=${encodeURIComponent(prueba)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        Swal.fire("No se generaron cruces.");
                        return;
                    }

                    sorteoCruces = data.map(cruce => ({
                        fase: fase,
                        prueba: prueba,
                        equipo1: cruce.equipo1,
                        equipo2: cruce.equipo2
                    }));

                    mostrarCruces(data);

                  
                    Swal.fire({
                        title: "¿Quieres guardar el sorteo?",
                        text: "Se guardarán en la base de datos.",
                        icon: "question",
                        showCancelButton: true,
                        confirmButtonText: "Sí, guardar",
                        cancelButtonText: "No, cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            guardarSorteo(sorteoCruces);
                        } else {
                           
                            Swal.fire("Los cruces no se han guardado.");
                            window.location.href = 'http://localhost:8080/ejemplo/';  // Redirección al inicio
                        }
                    });
                })
                .catch(error => {
                    console.error("Error en el sorteo:", error);
                    Swal.fire("Hubo un error en el sorteo.");
                });
        }



        function mostrarCruces(cruces) {
            let listadoCruces = document.getElementById("listadoCruces");
            listadoCruces.innerHTML = "<h2>Resultados del Sorteo</h2>";

            if (!Array.isArray(cruces) || cruces.length === 0) {
                listadoCruces.innerHTML += "<p>No se generaron cruces.</p>";
                return;
            }

            let lista = "<ul>";
            for (let cruce of cruces) {
                lista += `<li>Equipo ${cruce.equipo1} vs Equipo ${cruce.equipo2}</li>`;
            }
            lista += "</ul>";

            listadoCruces.innerHTML += lista;
        }

        function guardarSorteo(sorteoCruces) {
            fetch('http://localhost:8080/ejemplo/ProyectoServlet/guardarSorteo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cruces: sorteoCruces })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire("Los cruces han sido guardados exitosamente.");
                } else {
                    Swal.fire("Hubo un error al guardar los cruces.");
                }
            })
            .catch(error => {
                console.error("Error al guardar el sorteo:", error);
                Swal.fire("Hubo un error en la solicitud.");
            });
        }


    
    </script>
</body>
</html>
